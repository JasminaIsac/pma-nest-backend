generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Enums
enum ConversationType {
  PRIVATE @map("private")
  GROUP   @map("group")
}

enum ProjectStatus {
  NEW         @map("new")
  IN_PROGRESS @map("in_progress")
  COMPLETED   @map("completed")
}

enum TaskStatus {
  NEW         @map("new")
  IN_PROGRESS @map("in_progress")
  PAUSED      @map("paused")
  TO_CHECK    @map("to_check")
  COMPLETED   @map("completed")
  RETURNED    @map("returned")
}

enum TaskPriority {
  LOW      @map("low")
  MEDIUM   @map("medium")
  HIGH     @map("high")
}

enum UserRole {
  ROOT     @map("root")
  ADMIN    @map("admin")
  PROJECT_MANAGER @map("project_manager")
  DEVELOPER @map("developer")
}

enum UserStatus {
  ACTIVE   @map("active")
  INACTIVE @map("inactive")
  BANNED   @map("banned")
  DELETED  @map("deleted")
}

enum MessageStatus {
  SENT     @map("sent")
  DELIVERED @map("delivered")
  READ     @map("read")
}

enum LogAction {
  CREATE
  UPDATE
  DELETE
  LOGIN
  LOGOUT
}

enum LogEntity {
  PROJECT  @map("project")
  TASK     @map("task")
  USER     @map("user")
  CATEGORY @map("category")
}

model User {
  id                String               @id @default(uuid()) @db.Uuid
  email             String               @unique
  name              String
  role              UserRole
  tel               String               @unique
  location          String?
  password          String
  status            UserStatus           @default(ACTIVE)
  createdAt         DateTime             @default(now()) @map("created_at")
  updatedAt         DateTime             @updatedAt @map("updated_at")
  avatarUrl         String?              @map("avatar_url")
  deletedAt         DateTime?            @map("deleted_at")

  messagesSent      ConversationMessage[] @relation("MessageSender")
  conversations     ConversationParticipant[]
  tasks             Task[] 
  projectsManaged   Project[]            @relation("ManagerProjects")
  usersToProjects   UsersToProjects[]
  logs              Log[]

  @@map("users")
}

model Conversation {
  id            String                  @id @default(uuid()) @db.Uuid
  name          String
  type          ConversationType
  createdAt     DateTime                @default(now()) @map("created_at")
  updatedAt     DateTime                @updatedAt @map("updated_at")
  deletedAt     DateTime?               @map("deleted_at")

  participants  ConversationParticipant[]
  messages      ConversationMessage[]

  @@map("conversations")
}

model ConversationParticipant {
  id             String       @id @default(uuid()) @db.Uuid
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  conversationId String       @map("conversation_id") @db.Uuid
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId         String       @map("user_id") @db.Uuid
  joinedAt       DateTime     @default(now()) @map("joined_at")
  lastReadAt     DateTime?    @map("last_read_at")

  @@unique([conversationId, userId])
  @@map("conversation_participants")
}

model ConversationMessage {
  id             String         @id @default(uuid()) @db.Uuid
  conversation   Conversation   @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  conversationId String         @map("conversation_id") @db.Uuid
  sender         User           @relation("MessageSender", fields: [senderId], references: [id])
  senderId       String         @map("sender_id") @db.Uuid
  message        String
  createdAt      DateTime       @default(now()) @map("created_at")
  updatedAt      DateTime       @updatedAt @map("updated_at")
  status         MessageStatus  @default(SENT)
  deletedAt      DateTime?      @map("deleted_at")

  @@map("messages")
}

model Category {
  id         String    @id @default(uuid()) @db.Uuid
  name       String    @unique
  createdAt  DateTime  @default(now()) @map("created_at")
  updatedAt  DateTime  @updatedAt @map("updated_at")
  projects   Project[]
  deletedAt  DateTime? @map("deleted_at")

  @@map("categories")
}

model Project {
  id          String    @id @default(uuid()) @db.Uuid
  name        String
  description String?   @default("No description")
  categoryId  String    @map("category_id") @db.Uuid
  status      ProjectStatus @default(NEW)
  managerId   String    @map("manager_id") @db.Uuid
  coverUrl    String?   @map("cover_url")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")
  deadline    DateTime? 
  deletedAt   DateTime? @map("deleted_at")

  category    Category @relation(fields: [categoryId], references: [id])
  manager     User     @relation("ManagerProjects", fields: [managerId], references: [id])
  tasks       Task[]
  users       UsersToProjects[]

  @@map("projects")
}

model UsersToProjects {
  id        String      @id @default(uuid()) @db.Uuid
  projectId String      @map("project_id") @db.Uuid
  userId    String      @map("user_id") @db.Uuid
  createdAt DateTime    @default(now()) @map("created_at")
  updatedAt DateTime    @updatedAt @map("updated_at")
  userRole  UserRole    @default(DEVELOPER) @map("user_role")

  project   Project    @relation(fields: [projectId], references: [id], onDelete: Cascade, onUpdate: NoAction, map: "fk_project_user")
  user      User       @relation(fields: [userId], references: [id], onDelete: NoAction, onUpdate: NoAction, map: "users_to_projects_developer_id_fkey")

  @@unique([projectId, userId])
  @@map("users_to_projects")
}

model Task {
  id          String       @id @default(uuid()) @db.Uuid
  name        String
  description String?
  projectId   String       @map("project_id") @db.Uuid
  priority    TaskPriority @default(MEDIUM)
  assignedTo  String       @map("assigned_to") @db.Uuid
  deadline    DateTime
  createdAt   DateTime     @default(now()) @map("created_at")
  updatedAt   DateTime     @updatedAt @map("updated_at")
  status      TaskStatus   @default(NEW)
  deletedAt   DateTime?    @map("deleted_at")

  project     Project @relation(fields: [projectId], references: [id])
  assignee    User    @relation(fields: [assignedTo], references: [id])

  @@map("tasks")
}

model Log {
  id          String     @id @default(uuid()) @db.Uuid
  userId      String     @map("user_id") @db.Uuid
  entity      LogEntity 
  entityId    String?    @map("entity_id") @db.Uuid
  action      LogAction
  before      String?   
  after       String?   
  createdAt   DateTime   @default(now()) @map("created_at")

  user        User       @relation(fields: [userId], references: [id])

  @@map("logs")
}
